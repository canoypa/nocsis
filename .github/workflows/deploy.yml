name: Deploy

on:
  workflow_call:
    inputs:
      env:
        description: "Deployment environment (Preview or Production)"
        required: true
        type: string
      channelId:
        description: "Firebase Hosting channel id (required when env is Preview; Production always uses 'live')"
        required: false
        type: string
    secrets:
      DEPLOY_FIREBASE_HOSTING_SERVICE_ACCOUNT:
        required: true

concurrency:
  group: Deploy

jobs:
  build_functions:
    environment:
      name: ${{ inputs.env }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Tools
        uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
      - name: Install dependencies
        working-directory: ./functions
        run: pnpm install --prefer-frozen-lockfile
      - name: Build
        working-directory: ./functions
        run: pnpm run build
      - name: Upload Artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: functions-build
          path: ./functions/dist

  build_frontend:
    environment:
      name: ${{ inputs.env }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Tools
        uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
      - name: Install dependencies
        working-directory: ./frontend
        run: flutter pub get --enforce-lockfile
      - name: Generate OpenAPI spec
        run: pnpm install --prefer-frozen-lockfile && pnpm run generate-openapi
        working-directory: ./backend
      - name: Run build_runner
        working-directory: ./frontend
        run: flutter pub run build_runner build
      - name: Build
        working-directory: ./frontend
        run: flutter build web --wasm
      - name: Upload Artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: frontend-build
          path: ./frontend/build

  deploy_functions:
    needs: [build_functions]
    environment:
      name: ${{ inputs.env }}
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Download Functions Build Artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: functions-build
          path: ./functions/dist
      - name: Setup Tools
        uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
      - name: Install dependencies
        run: pnpm install --prefer-frozen-lockfile; cd functions && pnpm install --prefer-frozen-lockfile
      - name: Auth
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          workload_identity_provider: projects/219141289630/locations/global/workloadIdentityPools/github-action/providers/deploy-nocsis
          service_account: gh-actions-deploy@class-clock-40088.iam.gserviceaccount.com
      - name: Deploy Functions
        run: pnpm firebase deploy --only functions --force

  deploy_backend:
    environment:
      name: ${{ inputs.env }}
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Tools
        uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
      - name: Auth
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          workload_identity_provider: projects/219141289630/locations/global/workloadIdentityPools/github-action/providers/deploy-nocsis
          service_account: gh-actions-deploy@class-clock-40088.iam.gserviceaccount.com
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@e427ad8a34f8676edf47cf7d7925499adf3eb74f # v2.2.1
      - name: Deploy Backend
        run: gcloud run deploy backend --source ./backend --project class-clock-40088 --region asia-northeast1 --no-traffic
      - name: Set Traffic
        if: inputs.env == 'Production'
        run: gcloud run services update-traffic backend --to-latest --project class-clock-40088 --region asia-northeast1

  deploy_frontend:
    needs: [build_frontend, deploy_functions, deploy_backend]
    environment:
      name: ${{ inputs.env }}
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Download Frontend Build Artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: frontend-build
          path: ./frontend/build
      - name: Setup Tools
        uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
      - name: Install dependencies
        run: pnpm install --prefer-frozen-lockfile
      - name: Deploy Frontend
        id: deploy_frontend
        uses: FirebaseExtended/action-hosting-deploy@e2eda2e106cfa35cdbcf4ac9ddaf6c4756df2c8c # v0.10.0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.DEPLOY_FIREBASE_HOSTING_SERVICE_ACCOUNT }}
          channelId: ${{ inputs.env == 'Production' && 'live' || inputs.channelId }}
